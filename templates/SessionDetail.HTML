{% extends "Basis.HTML" %}

{% block content %}
<head>
    <title>{{ session_obj.title }} - Session Details</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='CSS/Booking.css') }}">
</head>
<body>
    <main style="max-width:600px;margin:2rem auto;">
        <h2>{{ session_obj.title }}</h2>
        <div style="margin-bottom:1rem;">{{ session_obj.description }}</div>
        <form id="bookingForm" method="POST" style="margin-top:2rem;">
            <p>Sort the events below by your preference (top = most preferred):</p>
            <ul id="eventList" style="list-style:none;padding:0;margin-bottom:2rem;">
            {% for event in session_obj.events %}
                <li class="event-item" draggable="true" style="padding:1rem 2rem;margin-bottom:1rem;background:#fff;border:2px solid #000;color:#000;font-size:1.2rem;cursor:move;border-radius:0;user-select:none;">{{ event }}<input type="hidden" name="event_order" value="{{ event }}"></li>
            {% endfor %}
            </ul>
            <button type="submit" class="btn" style="width:100%;height:60px;background:#fff;color:#000;border:2px solid #000;border-radius:0;font-size:1.1rem;">Book Session</button>
        </form>
    </main>
    <style>
        /* Smooth transitions for list items and ghost during drag */
        .event-item {
            transition: transform 160ms cubic-bezier(.2,.8,.2,1), box-shadow 160ms ease;
            will-change: transform;
        }
        .sortable-ghost {
            opacity: 0.85;
            transform: scale(0.99);
            box-shadow: 0 12px 30px rgba(0,0,0,0.12);
        }
        .dragging {
            opacity: 0.9;
        }
    </style>

    <!-- use SortableJS for smoother drag & drop with animation and touch support -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
    // Initialize Sortable on the list for smooth reordering
    const eventList = document.getElementById('eventList');
    new Sortable(eventList, {
        animation: 180,          // ms animation for moving elements
        ghostClass: 'sortable-ghost',
        dragClass: 'dragging',
        fallbackOnBody: false,
        swapThreshold: 0.65,
        chosenClass: 'chosen',
        onStart: function (evt) {
            // improve performance while dragging
            document.body.style.userSelect = 'none';
        },
        onEnd: function (evt) {
            document.body.style.userSelect = '';
        }
    });

    // On submit, update hidden inputs to match order (use values from text content)
    document.getElementById('bookingForm').addEventListener('submit', function(e) {
        const items = eventList.querySelectorAll('.event-item');
        // Remove existing hidden inputs so we generate a clean ordered set
        // (helps avoid stale inputs if JS reordered names previously)
        items.forEach((li, idx) => {
            let input = li.querySelector('input[type="hidden"]');
            if (!input) {
                input = document.createElement('input');
                input.type = 'hidden';
                li.appendChild(input);
            }
            input.name = 'event_order_' + idx;
            // textContent may include the hidden input's value; better to use a data attribute or strip the input value
            // We'll derive the event text by cloning the node and removing hidden inputs
            const clone = li.cloneNode(true);
            clone.querySelectorAll('input[type="hidden"]').forEach(i=>i.remove());
            input.value = clone.textContent.trim();
        });
    });
    </script>
</body>
{% endblock %}
